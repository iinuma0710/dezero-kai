# DeZero-Kai の実装 その4

## Step 20. 演算子のオーバロード その1
演算子のオーバロードに先立って、まずは積算関数クラス ```Mul``` を実装します。
$y = x_0 \times x_1$ の各変数に関する偏微分は、$\frac{\partial y}{\partial x_0} = x_1$、$\frac{\partial y}{\partial x_1} = x_0$ なので、最終的な出力を $L$ とすると、$\frac{\partial L}{\partial x_0} = x_1 \frac{\partial L}{\partial y}$、$\frac{\partial L}{\partial x_1} = x_1 \frac{\partial L}{\partial y}$　となります。  
ゆえに、```Mul``` クラスの実装は以下の通りです。

```python
class Mul(Function):
    def forward(self, x0, x1):
        y = x0 * x1
        return y
    
    def backward(self, gy):
        x0, x1 = self.inputs[0].data, self.inputs[1].data
        return gy * x1, gy * x2
    

def mul(x0, x1):
    return Mul()(x0, x1)
```

```Mul``` と ```Add``` を組み合わせて、$a \times b + c$ のような計算を ```add(mul(a, b), c)``` のように書けます。
ただ、いちいちこう書くのは煩わしいので、できれば ```a * b + c``` のような書き方ができると嬉しいです。そのために、演算子のオーバロードを実装します。
それには、変数クラスに ```__mul__``` メソッドを追加します。

```python
class Variable():
    ...
    
    def __mul__(self, other):
        return mul(self, other)
```

あるいは、以下のように書いても同じ意味になります。

```python
Variable.__mul__ = mul
```

## Step 21. 演算子オーバロード その2
```Variable``` もただのデータの入れ物ですので、```ndarray``` インスタンスや、```int``` 型や ```float``` 型の値と一緒に使えると便利です。
まずは、```ndarray``` インスタンスが渡されたときに、暗黙的に変数クラスに変換されるようにします。
具体的には、```as_variable``` 関数を用意し、関数クラスが呼び出されるタイミングで ```as_variable``` で変換されるようにします。

```python
def as_variable(obj):
    if isinstance(obj, Variable):
        return obj
    return Variable(obj)

class Function():
    def __call__(self, *inputs):
        inputs = [as_variable(x) for x in inputs]
        ...
```

次に、```as_array``` 関数を通してから足し算を行うようにすることで、```Variable``` とスカラ型の値の演算が可能になります。

```python
def mul(x0, x1):
    x1 = as_array(x1)
    return Mul()(x0, x1)
```

さらに、前のステップでは ```__mul__``` のみを実装しましたが、```Variable``` が右項にあった場合のために、```__rmul__``` も実装しておきます

```python
Variable.__rmul__ = mul
```

最後に、```ndarray``` と ```Variable``` の演算を考えます。
```ndarray``` が左項にあると、そちらの ```__add__``` が優先されてしまうため、必ず ```Variable``` の ```__radd__``` が呼ばれるように、```__array_priority__``` を設定しておきます。

```python
class Variable():
    __array_priority__ = 200
    ...
```